name: ChatGPT PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate diff
        id: diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git fetch --no-tags --prune --depth=2 origin ${BASE_SHA} ${HEAD_SHA}
          # Unified=0 = line-level diff; easier for LLMs to reason about
          git diff --unified=0 "${BASE_SHA}" "${HEAD_SHA}" > diff.patch
          # If diff is huge, truncate to ~200k chars to stay under token limits
          python - << 'PY'
import os, sys
p='diff.patch'
data=open(p,'r',encoding='utf-8',errors='ignore').read()
# Keep last 200k chars (most recent changes at end are often most relevant)
MAX=200_000
if len(data)>MAX:
    head = data[:100_000]
    tail = data[-100_000:]
    data = head + "\n\n--- TRUNCATED FOR LENGTH ---\n\n" + tail
open(p,'w',encoding='utf-8').write(data)
print(f"Final diff length: {len(data)}")
PY

      - name: Call OpenAI for review
        id: call
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          echo "Preparing prompt…"
          TITLE="${{ github.event.pull_request.title }}"
          BRANCH="${{ github.head_ref }}"
          REPO="${{ github.repository }}"
          PRNUM="${{ github.event.pull_request.number }}"
          DIFF_CONTENT="$(python - << 'PY'
import sys
print(open("diff.patch","r",encoding="utf-8",errors="ignore").read())
PY
)"
          # Build the instruction prompt
          read -r -d '' INPUT << 'EOF' || true
You are a senior TypeScript/Next.js reviewer for a repo that targets Android Termux users and runs on Vercel.
Perform a precise code review of this pull request.

Requirements:
- Identify bugs, risky changes, and broken imports.
- Flag performance issues and DX pitfalls (e.g., Turbopack/Next.js 16 gotchas).
- Suggest minimal diff patches when possible (code blocks).
- Note any missing tests or docs.
- Keep it concise but actionable.

Respond in Markdown with headings and bullets. Reference files and lines when clear.

--- PR Title ---
${TITLE}

--- Repo ---
${REPO}

--- Branch ---
${BRANCH}

--- DIFF (unified=0) ---
${DIFF_CONTENT}
EOF

          echo "Calling OpenAI…"
          RESPONSE_JSON="$(curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @- <<CURLJSON
{
  "model": "gpt-5.1-mini",
  "input": ${INPUT@Q},
  "max_output_tokens": 1400
}
CURLJSON
)"
          # Extract text safely (handles both 'output_text' and tool-style outputs)
          REVIEW="$(python - << 'PY'
import json, sys
j=json.load(sys.stdin)
# Prefer 'output_text' if present; else stitch from content
txt = j.get("output_text")
if not txt:
    parts=[]
    for c in j.get("output",[]):
        if c.get("type")=="message":
            for b in c.get("content",[]):
                if b.get("type")=="output_text":
                    parts.append(b.get("text",""))
    txt = "\n".join(parts) if parts else "(No review text returned.)"
print(txt)
PY
<<< "$RESPONSE_JSON")"

          # Save for next step
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = core.getInput('body', { required: true });
            const { context, github } = require('@actions/github');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
          result-encoding: string
          github-token: ${{ secrets.GITHUB_TOKEN }}
          inputs: |
            body<<EOF
            ${{ steps.call.outputs.review }}
            EOF
